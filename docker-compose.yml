---
version: "3"

networks:
  piwigo-network:
    name: album-network
    external: false

services:

  piwigo-main:
    image: piwigo/piwigo:latest
    restart: always
    #user: "1000:121"
    environment:
      - TZ=${timezone}
      # - PUID=1000
      # - PGID=121
    networks:
      - piwigo-network
    ports:
      - "80"
      #- "${piwigo_port}:80"
    depends_on:
      - piwigo-db
    volumes:
      - ./piwigo-data/piwigo:/var/www/html/piwigo/
      - ./piwigo-data/scripts:/usr/local/bin/scripts/
      - ${albumfiles}:/var/www/html/piwigo/galleries/Family

  piwigo-db:
    #image: mysql:lts
    image: mysql:8.0.41
    restart: always
    user: "${UID}:${GID}"
    environment:
      - MYSQL_RANDOM_ROOT_PASSWORD=true
      - MYSQL_USER=piwigodb_user
      - MYSQL_DATABASE=piwigodb
      # Defined in .env
      - MYSQL_PASSWORD=${db_user_password}
      - TZ=${timezone}
    networks:
      - piwigo-network
      #ports:
      #- "3306:3306"
    volumes:
      - ./piwigo-data/mysql:/var/lib/mysql

  nginx:
    image: nginx:latest
    container_name: piwigo-proxy
   # user: "${UID}:${GID}"

    environment:
      - TEST=ok
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./certbot-data/conf:/etc/letsencrypt
      - ./certbot-data/www:/var/www/certbot
    networks:
      - piwigo-network
    ports:
      - 9443:9443
    restart: unless-stopped

  certbot:
      image: certbot/dns-route53
      #user: "${UID}:${GID}"
      environment:
        - AWS_ACCESS_KEY_ID=${certbot_AWS_ACCESS_KEY_ID}
        - AWS_SECRET_ACCESS_KEY=${certbot_AWS_SECRET_ACCESS_KEY}
      volumes:
        - ./certbot-data/conf:/etc/letsencrypt
        - ./certbot-data/www:/var/www/certbot
      entrypoint: sh -c 'trap exit TERM; while :; do certbot renew --dns-route53; sleep 12h & wait $${!}; done;'
      restart: unless-stopped
